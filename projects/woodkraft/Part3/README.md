This section will cover the monitoring feature provided by KPS using the managed Promethues service.

For Prometheus we will enable metrics for mysqld and wordpress services created in [Part1](../Part1/README.md) to collect metrics from, we need to add a metrics endpoint to the services. For the purpose of this demo we will use the mysqld exporter to provide that for mysqld and wordpress exporter for the content server

# Enable Prometheus Service
Select the Project **E-Commerce Application** on the [Projects](https://karbon.nutanix.com/projects/list) page and go to **Manage Services**. Enable Kafka and Confirm the selection

This will start the prometheus service on the project "E-Commerce Application" ready to scrape metrics from services.

* Enable Mysqld with exporter
We will use the exporter provided [here](https://hub.helm.sh/charts/stable/prometheus-mysql-exporter/0.5.3) to scrape the Mysql metrics. Here is the generated yaml which can also be used [mysqld-exporter.yaml](prometheus/mysqld-exporter.yaml)

# Add Grafana service
TODO


# Enable Istio
Very similar to other services we can enable Istio also on our project
```
Dashboard -> Manage Services -> Enable Istio -> Confirm
```

**NOTE**: This will restart all apps in the project to enable Istio sidecar. If you prefer not to add Istio to a particular application, please add the following annotation to your Deployment metadata. Here are addition [details](https://istio.io/latest/docs/setup/additional-setup/sidecar-injection/)

```
sidecar.istio.io/inject: "false"
```

Once Istio is enabled on the Service Domain for the project we can deploy V2 of the recommendation-service and experiment with the routing rules.

# Installing Recommendation-Service V2
* Go to **Ecommerce Application** project
* Create an application via the Admin Console
  **Kubernetes App** -> **Create**
* Name it **recommendation-service-v2**
* Add the required Service Domains to the app.
* Use the [recommendation-service-v2.yaml](istio/recommendation-service-v2.yaml) as the application manifest

This will install the v2 version of the app, which essentially changes the color of the graph to green. It will also add a single VirtualService which will point to the version v1 of the service, so with this there should be no change in the graph that you see on the Recommendations link.

You can verify the VirtualService in the Project console here:
  **Istio** -> **Virtual Services**
To exercise the switch to v2 of the recommendation service, edit the VirtualService in the yaml file to make is v2. You can do it directly in the UI.
After the edits the VirtualService should look like this
```
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: recomm-svc
spec:
  hosts:
  - recommendation-service
  http:
  - route:
    - destination:
        host: recommendation-service
        subset: v2
```

Once this is applied, you can see the v2 subset in the Virtual Service listing on the UI.
Now you can refresh the Ecommerce App and go to the Recommendation link to see the green graph generated by V2 version of Recommendation Service. You can now apply different rules like 80/20 traffic split and experiment with istio
